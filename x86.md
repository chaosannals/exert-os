# x86

## 分页

32位虚拟地址

12bit 正好表示 4KB
22bit 正好表示 4MB

Cr4：可以使得大页由默认的 4MB 变成 2MB

- 4KB: 10（PDE) + 10（PTE）+ 12（页内位移）
- 2MB: 
- 4MB: 10（PDE) + 22（页内位移）

Cr3：高20页基址  低12（标识只有几位可用）

- PDE 物理地址 = Cr3基址 + 10（PDE）（注：物理地址 = 大页获取帧基址 + 22 页内位移）
- PTE 物理地址 = PDE获取 + 10（PTE）（注：物理地址 = 获取基址 + 12 页内位移）
- 物理地址 = 由上各级基址 加上 页内位移，详见上注。

### 页表帧结构

- 0 是否物理内存
- 1 是否可写
- 2 是否用户态
- 3 write through 是否写入直接进入内存
- 4 cache disabled 禁止缓存
- 5 是否访问过（CPU 自动设置）
- 6 是否写入过（CPU 自动设置）
- 7 是否大页 （0 4KB  1 4MB 或配置 Cr4 位 2MB）
- 8 全局页
- 9-11 (随意)
- 12-31 页基址
- 12 （大页）属性
- 13-21 （大页）保留
- 22-31 （大页）基址

## PAE 分页（32位可寻址 64GB 内存）

表帧变成 64位， 12-35 位 共 24bit 作为基址，使得 24 + 12（页内位移）= 36

因为表帧变宽所以 2^9 * 8（64bit=8byte）= 4KB 表还是和 32位普通的分页占同样的大小。

由于 Cr3 还是 32位的，所以 PDP 表只能在 4G 的物理地址内。PDE 和 PTE 的表地址才能使用 36bit 的物理地址宽

32位虚拟地址

- 4KB: 2（PDP) + 9（PDE） + 9（PTE）+ 12（页内位移）
- 2MB: 2（PDP）+ 9 (PDE)  + 21（页内位移）

Cr3：高27页基址  低5（为 0）

### 页表帧结构

PDP 

- 0 是否物理内存
- 1-2 必须为0
- 3 PWT page write through 是否写入直接进入内存
- 4 cache disabled 禁止缓存
- 5 是否访问过（CPU 自动设置）
- 6 是否写入过（CPU 自动设置）
- 7 是否大页 （0 时 4KB; 1 时 2MB）
- 8 全局页
- 9-11 （随意）
- 12-36  物理基址
- 37-62 （随意）
- 63 是否不可执行
